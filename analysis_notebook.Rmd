---
title: "Get time series "
output: html_notebook
---

COVID 19 number of cases over time 

```{r}
pacman::p_load(tidyverse, here)

```


Get from series of files 


```{r}
all_files <- 
  list.files(here("csse_covid_19_data", "csse_covid_19_daily_reports"), pattern = "\\.csv$")

dtablk <- tibble(
  filename = all_files
) %>% 
  mutate(
    date = str_remove(filename, "\\.csv$"),
    loc = here("csse_covid_19_data", "csse_covid_19_daily_reports", filename)
  ) %>% 
  mutate(
    data = map(loc, read_csv)
  ) %>% 
  select(date, data) %>% 
  mutate(num_var = map_dbl(data, ncol))
  
dtablk
```


Let's work with those dataframes with 6 vars first, then 8 vars

```{r}
# Drop latitude, longitude, and last update 
tidied_data <- 
dtablk %>% 
  mutate(dta_simple = map(data, ~ .x %>% select(`Province/State`, `Country/Region`, Confirmed, Deaths, Recovered))) %>% 
  select(date, dta_simple) %>% 
  unnest(dta_simple) %>% 
  gather(key = "type", value = n, Confirmed:Recovered) %>% 
  mutate(n = ifelse(is.na(n), 0, n)) %>% 
  mutate(date = lubridate::mdy(date)) %>% 
  select(date, higher = `Province/State`, lower = `Country/Region`, type, n) %>% 
  mutate(type = tolower(type))
```


```{r}
tidied_data %>%
  filter(type == "confirmed") %>%  
  group_by(date) %>% 
  summarise(total_confirmed = sum(n)) %>% 
  ungroup() %>% 
  ggplot(aes(x = date, y = total_confirmed)) + 
  geom_point()  + 
  scale_y_log10()
  

```

Now after Feb 15


```{r, fig.width = 12, fig.height = 9}
tidied_data %>%
  filter(type == "confirmed") %>%  
#  filter(date > lubridate::dmy("15-02-2020")) %>% 
  group_by(date) %>% 
  summarise(total_confirmed = sum(n)) %>% 
  ungroup() %>% 
  mutate(month = lubridate::month(date, label = TRUE)) %>% 
  ggplot(aes(x = date, y = total_confirmed)) + 
  geom_point()  + 
  scale_y_log10(  
    breaks = c(
      2 * 10 ^ 3, 
      5 * 10 ^ 3, 
      1 * 10 ^ 4, 
      2 * 10 ^ 4, 
      5 * 10 ^ 4, 
      1 * 10 ^ 5, 
      2 * 10 ^ 5,
      5 * 10 ^ 5,
      1 * 10 ^ 6,
      2 * 10 ^ 6,
      5 * 10 ^ 6,
      1 * 10 ^ 7,
      2 * 10 ^ 7
      ),
    labels = c(
      "2k", "5k",
      "10k", "20k", "50k",
      "100k", "200k", "500k",
      "1M", "2M", "5M",
      "10M", "20M"
      
    ), 
    limits = c(2 * 10 ^ 3, 10 ^ 7)
    ) + 
  scale_x_date(date_breaks = "1 day") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  stat_smooth(
    aes(group = month),
    method = "lm", se = FALSE 
  ) +
  labs(
    x = "Date", y = "Total cases confirmed (log scale)",
    title = "Total worldwide COVID-19 cases confirmed by date after 15 Feb",
    subtitle = "Log scale. Regression lines broken by month",
    caption = "Source: Johns Hopkins CSSE"
  )

ggsave(here("figures", "covid_19_confirmed_from15feb.png"), height = 20, width = 25, units = "cm", dpi = 300)
  
  

```

```{r}
tidied_data %>%
  filter(type == "confirmed") %>%  
  filter(date > lubridate::dmy("15-02-2020")) %>% 
  group_by(date) %>% 
  summarise(total_confirmed = sum(n)) %>% 
  ungroup() %>% 
  mutate(month = lubridate::month(date, label = TRUE)) %>% 
  ggplot(aes(x = date, y = total_confirmed)) + 
  geom_point()  + 

  
  scale_x_date(date_breaks = "1 day") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  stat_smooth(
    aes(group = month),
    method = "lm", se = FALSE 
  ) +
  labs(
    x = "Date", y = "Total cases confirmed (log scale)",
    title = "Total worldwide COVID-19 cases confirmed by date after 15 Feb",
    subtitle = "Log scale. Regression lines broken by month",
    caption = "Source: Johns Hopkins CSSE"
  )

```